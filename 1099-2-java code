package com.geeks.demo.core.servlets;

import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Iterator;
import java.util.List;

import javax.servlet.Servlet;
import javax.servlet.ServletException;

import org.apache.commons.lang3.StringUtils;
import org.apache.sling.api.SlingHttpServletRequest;
import org.apache.sling.api.SlingHttpServletResponse;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ResourceResolver;
import org.apache.sling.api.servlets.HttpConstants;
import org.apache.sling.api.servlets.ServletResolverConstants;
import org.apache.sling.api.servlets.SlingAllMethodsServlet;
import org.osgi.framework.Constants;
import org.osgi.service.component.annotations.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.adobe.cq.dam.cfm.ContentElement;
import com.adobe.cq.dam.cfm.ContentFragment;
import com.adobe.cq.dam.cfm.ContentFragmentException;
import com.google.gson.stream.JsonWriter;
import com.opencsv.CSVReader;
import com.opencsv.CSVReaderBuilder;

@Component(
        service = Servlet.class,
        property = {
                Constants.SERVICE_DESCRIPTION + "=" + CreateGenericContentFragment.SERVICE_DESCRIPTION,
                ServletResolverConstants.SLING_SERVLET_PATHS + "=" + "/bin/content/createContentFragment",
                ServletResolverConstants.SLING_SERVLET_METHODS + "=" + HttpConstants.METHOD_POST,
                ServletResolverConstants.SLING_SERVLET_METHODS + "=" + HttpConstants.METHOD_GET
        }
)
public class CreateGenericContentFragment extends SlingAllMethodsServlet {
    private static final Logger LOGGER = LoggerFactory.getLogger(CreateGenericContentFragment.class);
    private static final long serialVersionUID = 1L;

    protected static final String SERVICE_DESCRIPTION = "Create Generic Content Fragment from CSV";
    protected static final String CF_TEMPLATE = "/conf/geeksdemo/settings/dam/cfm/models/";
   // protected static final String[] EXCEPTION_LIST = new String[] {"branchId"};

    private static final String PARENT_PATH = "parentPath";
    private static final String MODEL_TYPE = "modelType";
    private static final String CSV = "csv";

    @Override
    protected void doPost(SlingHttpServletRequest request, SlingHttpServletResponse response) throws IOException {
        LOGGER.debug("Received POST request to create content fragment.");
        request.setCharacterEncoding("UTF-8");
        response.setContentType("application/json");
        response.setHeader("Cache-Control", "nocache");
        response.setCharacterEncoding("utf-8");
        
        JsonWriter jsout = new JsonWriter(response.getWriter());
        jsout.beginObject();
        
        LOGGER.info("Inside doPost method.");
        LOGGER.info(CF_TEMPLATE);
        LOGGER.info(MODEL_TYPE);
        LOGGER.info("parent_pathg :"+PARENT_PATH);

        //content/dam/geeksdemo
        String parentPath = request.getParameter(PARENT_PATH);
        
        //CSV Model
        String modelType = request.getParameter(MODEL_TYPE);
        LOGGER.info("parent_path :"+parentPath);
        LOGGER.info("modelType :"+modelType);

        ResourceResolver resolver = request.getResourceResolver();

        try {
        	//import org.apache.commons.lang3.StringUtils;
            if (StringUtils.isNotEmpty(parentPath) && StringUtils.isNotEmpty(modelType)) {
                LOGGER.info("Parent path and model type are not empty.");
                //StringUtils.i

                Part filePart = request.getPart(CSV);
                InputStream fileContent = filePart.getInputStream();
                LOGGER.info("fileContent :"+fileContent);

                CSVReader header = new CSVReaderBuilder(new InputStreamReader(fileContent)).withSkipLines(0).build();
             // Read the header line from the CSV file and store it as a list of strings
                
                List<String> headerList = Arrays.asList(header.readNext());
                LOGGER.info("headerList :"+headerList);
                
// -------------------------------------------------------------------------------------------------------------------------------------
//                List<String> resourceList = header.readAll().stream()
//                        .filter(data -> StringUtils.isNotEmpty(data[0]))
//                        .map(data -> {
//                            createContentFragment(resolver, parentPath, headerList, data, modelType);
//                            return "Yes";
//                        }).collect(Collectors.toList());
// -------------------------------------------------------------------------------------------------------------------------------------

                
                List<String> resourceList = new ArrayList<>();
                
                List<String[]> allRows = header.readAll(); // Read all rows from the CSV file

                for (String[] data : allRows) {
                    if (StringUtils.isNotEmpty(data[0])) { // Check if the first column of the row is not empty
                        createContentFragment(resolver, parentPath, headerList, data, modelType);
                        resourceList.add("Yes");
                    }
                }


                LOGGER.info("resources size :"+resourceList.size());

                jsout.name("status").value("Success Created total of " + resourceList.size() + " Content Fragments");
            }

        } catch (IOException | ServletException e) {
            LOGGER.error("Exception occurred while processing POST request.", e);
            jsout.name("status").value("Failed Created all Content Fragments");
        } finally {
            if (resolver != null && resolver.hasChanges()) {
                resolver.commit();
            }
        }

        jsout.endObject();
    }
  //From the above code we are getting the details about cf headers and cf data
    
    
    
    //Now whatever the data we have got , Using the data we need to create the cf's using below code

    public void createContentFragment(ResourceResolver resourceResolver, String parentPath, List<String> headerList, String[] data, String modelType) {
    	    
    	    LOGGER.info("Resource Resolver: " + resourceResolver);

    	    LOGGER.info("Parent Path: " + parentPath);

    	    LOGGER.info("Header List: " + headerList);

    	    LOGGER.info("Data: " + Arrays.toString(data));

    	    LOGGER.info("Model Type: " + modelType);

            LOGGER.info("In create content fragment :"+data[0] +" "+data[1]+" "+data[2]);

        try {
            Resource modelResource = resourceResolver.getResource(parentPath + "/" + data[0]);
           // LOGGER.info(String.valueOf(modelResource));
            LOGGER.info("modelResource: " + modelResource);
            
                     //  ContentFragment newFragment = null;
            
            //Implementations of this interface allow to access content fragments through a stable API, independently from the actual content structure.

                       ContentFragment 	 newFragment = modelResource.adaptTo(ContentFragment.class);
                        LOGGER.info("newFragment: " + newFragment);
                        
// -------------------------------------------------------------------------------------------------------------------------------------
            
//            if (modelResource == null) {
//            	
//            	//From this line we are getting this path "templateOrModelRsc=/conf/mysite/settings/dam/cfm/models/csv-model"
//                Resource templateOrModelRsc = resourceResolver.getResource(CF_TEMPLATE + modelType);
//                LOGGER.info("CF_TEMPLATE :"+CF_TEMPLATE);
//                LOGGER.info("templateOrModelRsc :"+templateOrModelRsc);
//                Resource parentResource = resourceResolver.getResource(parentPath);
//                FragmentTemplate tpl = templateOrModelRsc.adaptTo(FragmentTemplate.class);
//                   newFragment = tpl.createFragment(parentResource, data[0], data[0]);
//            } else {
//            	 newFragment = modelResource.adaptTo(ContentFragment.class);
//                LOGGER.info("newFragment: " + newFragment);
//            }
// -------------------------------------------------------------------------------------------------------------------------------------


            if ( newFragment != null) {
                Iterator<ContentElement> elements = newFragment.getElements();
                
                //elements=
                while (elements.hasNext()) {
                    ContentElement element = elements.next();

                    for (int i = 0; i < headerList.size(); i++) {
                        LOGGER.info("headerList.size(): " + headerList.size());

                        if (StringUtils.equalsIgnoreCase(element.getName(), headerList.get(i)) || StringUtils.containsAny(element.getName())) 
                        	LOGGER.info("gopal: " + (StringUtils.equalsIgnoreCase(element.getName(), headerList.get(i)) || StringUtils.containsAny(element.getName())));
                            LOGGER.info("rahul " + element.getName());
                        {
                            element.setContent(data[i], element.getContentType());
                            break;
                        }
                    }
                }
            }
        } catch (ContentFragmentException e) {
            LOGGER.error("Exception occurred while creating content fragment.", e);
        }

    }
}
